- name: Install Openstack SIG repo
  ansible.builtin.package:
    name: centos-release-openstack-zed.noarch
    state: present

- name: Make sure required package are installed
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  with_items:
    - libvirt
    - virt-v2v
    - qemu-kvm
    - python3-openstackclient
    - wget

- name: Check if vmware-vix-disklib is present
  ansible.builtin.shell: rpm -q vmware-vix-disklib
  register: vmware_vix_disklib_installed
  ignore_errors: true

- name: Install vmware vix disklib
  ansible.builtin.shell: |
    wget {{ vmware_vix_disklib_url }}/{{ vmware_vix_disklib }}
    dnf localinstall -y {{ vmware_vix_disklib }}
  when: vmware_vix_disklib_installed.rc != 0

- name: Check if virt-v2v-in-place exists in libexec
  stat:
    path: /usr/libexec/virt-v2v-in-place
  register: libexec_stat

- name: Check if virt-v2v-in-place is in $PATH
  shell: "command -v virt-v2v-in-place || true"
  register: virt_in_path
  changed_when: false

- name: Copy /usr/libexec/virt-v2v-in-place to /usr/bin if not in $PATH
  copy:
    src: /usr/libexec/virt-v2v-in-place
    dest: /usr/bin/virt-v2v-in-place
    mode: '0755'
  when:
    - libexec_stat.stat.exists
    - virt_in_path.stdout == ""

- name: Create configuration directory .config/openstack
  ansible.builtin.file:
    path: "~/.config/openstack"
    recurse: yes
    state: directory

- name: Create os-migrate data dir
  ansible.builtin.file:
    path: "{{ os_migrate_data_dir }}"
    state: directory
    recurse: yes

- name: Set Openstack credentials clouds.yaml file
  ansible.builtin.copy:
    src: "{{ os_migrate_clouds_path|default(os_migrate_data_dir ~ '/clouds.yaml') }}"
    dest: "~/.config/openstack/clouds.yaml"
  when: copy_openstack_credentials_to_conv_host|default(true)|bool
